apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: team-selector
spec:
  description: Test selector team strategy with AI-driven participant selection
  # Selector strategy requires multiple AI model calls for participant selection
  # and can take longer than default timeouts, especially with maxTurns: 6
  steps:
  - name: step-1
    try:
    - script:
        skipLogOutput: true
        content: |
          set -u
          echo "{\"token\": \"$E2E_TEST_AZURE_OPENAI_KEY\", \"url\": \"$E2E_TEST_AZURE_OPENAI_BASE_URL\"}"
        outputs:
        - name: azure
          value: (json_parse($stdout))
    - apply:
        file: manifests/*.yaml
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Model
          metadata:
            name: test-model
          status:
            conditions:
            - type: ModelAvailable
              status: "True"
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Agent
          metadata:
            name: researcher
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Agent
          metadata:
            name: analyst
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Agent
          metadata:
            name: coordinator
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Team
          metadata:
            name: selector-team
          spec:
            strategy: selector
            maxTurns: 6
            selector:
              model: test-model
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Query
          metadata:
            name: selector-team-query
          status:
            phase: done
    - assert:
        resource:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Query
          metadata:
            name: selector-team-query
          status:
            (length(responses)): 1
            (contains(responses[*].target.name, 'selector-team')): true
            (length(join('', responses[*].content)) > `200`): true
    catch:
    - events: {}
    - describe:
        apiVersion: ark.mckinsey.com/v1alpha1
        kind: Query
        name: selector-team-query
    - script:
        content: |
          echo "Validating participant selection events..."
          events=$(kubectl get events -n $NAMESPACE --field-selector involvedObject.name=selector-team-query,involvedObject.kind=Query -o json)
          participant_selections=$(echo "$events" | jq '[.items[] | select(.reason == "ParticipantSelected" or .reason == "TeamParticipantSelected" or (.message // "" | contains("selected participant")) or (.message // "" | contains("Selected participant")))] | length')
          
          if [ "$participant_selections" -gt 0 ]; then
              echo "Found $participant_selections participant selection events"
              echo "$events" | jq -r '.items[] | select(.reason == "ParticipantSelected" or .reason == "TeamParticipantSelected" or (.message // "" | contains("selected participant")) or (.message // "" | contains("Selected participant"))) | "Event: \(.reason) - \(.message)"'
          else
              echo "No explicit participant selection events found, checking for team execution events..."
              team_events=$(echo "$events" | jq '[.items[] | select((.reason // "") | contains("Team") or contains("Agent"))] | length')
              echo "Found $team_events team/agent execution events"
              if [ "$team_events" -gt 0 ]; then
                  echo "Team execution events indicate selector strategy is working"
                  echo "Sample events:"
                  echo "$events" | jq -r '.items[0:3][] | "  \(.reason): \(.message // "No message")"'
              fi
          fi

          if [ ${#response} -gt 200 ]; then
              echo "Selector team AI-driven participant selection produced comprehensive response"
          else
              echo "WARNING: Response might be shorter than expected for selector team execution"
          fi
